<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css?v=2.4">
    <title>ChemFlow</title>
    <script>
      window.MathJax = {
        tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], packages: {'[+]': ['mhchem']} },
        loader: { load: ['[tex]/mhchem'] }
      };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="reactions.js"></script> 
</head>
<body>

<div class="container">
    <h1 style="text-align: center; color: #2ECC71;">üß™ ChemFlow</h1>
    
    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px;">
        <button class="theme-switch-inline" onclick="startStudyMode()">üìñ Flashcards</button>
        <button class="theme-switch-inline" onclick="toggleTheme()" id="themeBtn">üåô Dark Mode</button>
    </div>

  <div class="tag-bar">
  <button class="tag-btn" onclick="filterByTag('Naming')">#Naming</button>
  <button class="tag-btn" onclick="filterByTag('Test')">#Test</button>
  <button class="tag-btn" onclick="filterByTag('Oxidation')">#Oxidation</button>
  <button class="tag-btn" onclick="filterByTag('Reduction')">#Reduction</button>
  <button class="tag-btn" onclick="filterByTag('Alkene')">#Alkene</button>
  <button class="tag-btn" onclick="filterByTag('Alkyne')">#Alkyne</button>
 <button class="tag-btn reset-btn" 
    onclick="document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('active')); render(reactionDatabase)">
    Clear All
</button>
</div>
    
    <input type="text" id="mainSearch" class="search-bar" placeholder="Search by reagent or reaction name...">
    <div id="feed"></div>
<div id="reaction-detail" style="display: none;">
    <button onclick="goBack()" class="back-btn">‚Üê Back to Feed</button>
    <div id="detail-content">
        </div>
</div>
    <div style="text-align: center; margin-top: 50px;">
        <input type="password" id="adminKey" placeholder="Admin Access" oninput="runSearch()" style="border:none; background:none; text-align:center; color:#ccc; font-size:11px; outline:none; width: 100px;">
    </div>
</div>

<button id="fab" onclick="toggleForm()" style="position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%; background:#2ecc71; color:white; border:none; font-size:30px; cursor:pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index:1000;">+</button>

<div id="formOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center;">
    <div style="background:var(--card-bg, white); padding:20px; border-radius:15px; width:90%; max-width:400px; position:relative;">
        <span onclick="toggleForm()" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:20px;">&times;</span>
        <h2 style="color:#2ecc71; margin-top:0;">Add Reaction</h2>
        <input type="text" id="newName" placeholder="Reaction Name" style="width:100%; margin:5px 0; padding:8px;">
        <input type="text" id="newReagent" placeholder="Reagent" style="width:100%; margin:5px 0; padding:8px;">
        <input type="text" id="newFunction" placeholder="Function" style="width:100%; margin:5px 0; padding:8px;">
        <input type="text" id="newWarning" placeholder="Warning" style="width:100%; margin:5px 0; padding:8px;">
        <input type="text" id="newDiagram" placeholder="Diagram URL" style="width:100%; margin:5px 0; padding:8px;">
        <input type="text" id="newNotes" placeholder="Hacks (comma separated)" style="width:100%; margin:5px 0; padding:8px;">
        <button onclick="addReaction()" style="width:100%; padding:10px; background:#2ecc71; color:white; border:none; border-radius:5px; margin-top:10px;">Post</button>
    </div>
</div>

<div id="studyOverlay" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); flex-direction: column; align-items: center; justify-content: center; z-index: 5000;">
    <button onclick="exitStudyMode()" style="position:absolute; top:20px; right:20px; background:white; border:none; border-radius:50%; width:40px; height:40px; font-weight:bold; cursor:pointer; z-index: 6000;">‚úï</button>
    <div id="flashcard-container"></div>
    <p style="color:white; margin-top:20px; font-family: sans-serif;">Tap to Flip ‚Ä¢ Swipe up for Next</p>
</div>

<script>
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);

    const firebaseConfig = {
        apiKey: "AIzaSyDIW-SJkO5j4PwN1SDjMxGD_aQdoDHD6CU",
        authDomain: "organic-chem-b2ff8.firebaseapp.com",
        projectId: "organic-chem-b2ff8",
        databaseURL: "https://organic-chem-b2ff8-default-rtdb.firebaseio.com",
        storageBucket: "organic-chem-b2ff8.firebasestorage.app",
        messagingSenderId: "799844686854",
        appId: "1:799844686854:web:b9014316afd5ba5233f787"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let allReactions = [];
    let studyData = [];
    let studyIndex = 0;
    let currentFilter = 'All';

    db.ref('custom_reactions').on('value', (snapshot) => {
        const data = snapshot.val();
        const custom = [];
        for(let id in data) custom.push({...data[id], firebaseId: id});
        allReactions = (typeof reactionDatabase !== 'undefined') ? [...reactionDatabase, ...custom] : custom;
        runSearch();
    });

    function runSearch() {
        const query = document.getElementById('mainSearch').value.toLowerCase();
        const filtered = allReactions.filter(r => {
            const matchesSearch = (r.reagent?.toLowerCase().includes(query)) || (r.name?.toLowerCase().includes(query));
            const matchesFilter = (currentFilter === 'All' || r.category === currentFilter);
            return matchesSearch && matchesFilter;
        });
        render(filtered);
    }

 function render(data) {
    const feed = document.getElementById('feed');
    
    // Check if there are any results
    if (!data || data.length === 0) {
        feed.innerHTML = '<p style="color: #666; text-align: center; margin-top: 20px;">No reactions found matching your search.</p>';
        return;
    }

    // Generate the list of simple cards
    feed.innerHTML = data.map((r, index) => {
        return `
            <div class="card" onclick="openReaction(${index})" style="cursor:pointer; margin-bottom:15px; padding: 20px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(46, 204, 113, 0.2);">
                <h3 style="color: var(--accent); margin:0; font-size: 1.4rem;">${r.reagent}</h3>
                <p style="font-weight:bold; margin:8px 0; color: #fff; font-size: 1.1rem;">${r.name || ''}</p>
                <small style="color: #aaa; font-style: italic;">${r.function || ''}</small>
            </div>
        `;
    }).join('');
    
    // Format any math symbols if you are using them
    if (window.MathJax) window.MathJax.typeset();
}
    function openReaction(index) {
    // 1. Get the data
    const r = reactionDatabase[index]; 
    
    // 2. Hide Home Content
    const topSection = document.querySelector('.top-section-container');
    if (topSection) topSection.style.display = 'none';
    document.getElementById('feed').style.display = 'none';
    document.getElementById('mainSearch').style.display = 'none';

    // 3. Setup Detail Page
    const detailView = document.getElementById('reaction-detail');
    const detailContent = document.getElementById('detail-content');

    detailContent.innerHTML = `
        <h1 style="color: var(--accent); margin-bottom: 5px;">${r.reagent}</h1>
        <h2 style="margin-top: 0; color: #fff; opacity: 0.8;">${r.name || ''}</h2>
        <hr style="border: 0; border-top: 1px solid #333; margin: 20px 0;">
        
        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <p style="color: #2ecc71; font-weight: bold; margin-bottom: 10px;">Function:</p>
            <p style="color: #eee; margin: 0;">${r.function || 'N/A'}</p>
        </div>

        ${r.diagram ? `<div style="text-align:center; margin: 20px 0;"><img src="${r.diagram}" style="max-width:100%; border-radius:10px; border: 1px solid #444;"></div>` : ''}
        
        <div style="background:#222; padding:15px; border-radius:8px; border-left: 4px solid var(--accent); margin-bottom: 20px;">
            <strong style="color: var(--accent);">Example/Mechanism:</strong>
            <p style="color: #ccc; margin-top: 10px;">${r.example || 'No example available.'}</p>
        </div>

        <div style="background: rgba(46, 204, 113, 0.1); padding: 15px; border-radius: 8px;">
            <strong style="color: #2ecc71;">Hacks & Notes:</strong>
            <p style="color: #eee; margin-top: 10px;">${r.notes || 'No extra notes.'}</p>
        </div>

        ${r.warning ? `<p style="color:#ff4757; background: rgba(255, 71, 87, 0.1); padding: 10px; border-radius: 5px; margin-top: 20px;">‚ö†Ô∏è <strong>Warning:</strong> ${r.warning}</p>` : ''}
    `;

    // 4. Show and Scroll Up
    detailView.style.display = 'block';
    window.scrollTo(0, 0);
}

function goBack() {
    // Hide Detail, Show Home
    document.getElementById('reaction-detail').style.display = 'none';
    
    const topSection = document.querySelector('.top-section-container');
    if (topSection) topSection.style.display = 'block';
    document.getElementById('feed').style.display = 'flex';
    document.getElementById('mainSearch').style.display = 'block';
}
 function filterByTag(tagName) {
    console.log("Filtering for:", tagName);

    // 1. Remove 'active' green class from ALL buttons
    document.querySelectorAll('.tag-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // 2. Add 'active' class to the button you just clicked
    const clickedBtn = Array.from(document.querySelectorAll('.tag-btn'))
                            .find(btn => btn.innerText.includes(tagName));
    if (clickedBtn) clickedBtn.classList.add('active');

    // 3. Filter the data
    const filtered = reactionDatabase.filter(r => 
        r.tags && r.tags.includes(tagName)
    );
    
    // 4. Update the UI
    render(filtered); 
}

    function toggleExpand(index) {
        const d = document.getElementById(`details-${index}`);
        const isOpening = d.style.display === 'none';
        d.style.display = isOpening ? 'block' : 'none';
        if(isOpening) {
            const r = allReactions[index];
            const cleanKey = (r.reagent || 'unknown').replace(/\s+/g, '_').replace(/[.#$/[\]]/g, "_");
            loadNotes(cleanKey, index);
        }
    }

    function renderFlashcard() {
        if (!studyData.length) return;
        const r = studyData[studyIndex];
        const container = document.getElementById('flashcard-container');
        
        // Ensure strings exist to prevent "undefined" showing up
        const reagent = r.reagent || "No Reagent";
        const name = r.name || "";
        const func = r.function || "No Function Listed";
        const example = r.example || "";
        const diagramHtml = r.diagram ? `<img src="${r.diagram}" class="reaction-diagram" style="max-height:100px;">` : '';
        const warningHtml = r.warning ? `<p style="color:red; font-size:0.8em; margin:5px 0;">‚ö†Ô∏è ${r.warning}</p>` : '';

        container.innerHTML = `
            <div class="flashcard" id="currentFlashcard" onclick="this.classList.toggle('flipped')">
                <div class="flashcard-inner">
                    <div class="card-front">
                        <small>REAGENT</small>
                        <h1 style="font-size:2.2em; margin:10px 0;">${reagent}</h1>
                        <p>${name}</p>
                    </div>
                    <div class="card-back" onclick="event.stopPropagation(); this.parentElement.parentElement.classList.toggle('flipped')">
                        ${diagramHtml}
                        <h2 style="color:#2ecc71; margin:0; font-size:1.2em;">${func}</h2>
                        <div style="background:#f0f0f0; padding:10px; border-radius:8px; width:100%; color:#333; font-size:0.8em; margin:10px 0;">
                            ${example}
                        </div>
                        ${warningHtml}
                        <button onclick="event.stopPropagation(); nextCard()" style="background:#2ecc71; color:white; border:none; padding:12px 25px; border-radius:25px; margin-top:auto; font-weight:bold; cursor:pointer;">Next ‚Üí</button>
                    </div>
                </div>
            </div>
        `;
        
        const card = document.getElementById('currentFlashcard');
        let touchStartY = 0;
        card.addEventListener('touchstart', e => touchStartY = e.touches[0].clientY);
        card.addEventListener('touchend', e => {
            if (touchStartY - e.changedTouches[0].clientY > 70) nextCard();
        });

        if (window.MathJax) window.MathJax.typeset();
    }

    function startStudyMode() {
        if (!allReactions.length) return alert("No reactions to study!");
        studyData = [...allReactions].sort(() => Math.random() - 0.5);
        studyIndex = 0;
        document.getElementById('studyOverlay').style.display = 'flex';
        renderFlashcard();
    }

    function exitStudyMode() { document.getElementById('studyOverlay').style.display = 'none'; }
    function nextCard() { studyIndex = (studyIndex + 1) % studyData.length; renderFlashcard(); }

    // Notes and Other Utils
    function postNote(reagentKey, index) {
        const input = document.getElementById(`note-input-${index}`);
        const noteText = input.value;
        if(!noteText) return;
        db.ref('community_notes/' + reagentKey).push({ text: noteText, timestamp: Date.now() }).then(() => {
            input.value = "";
            loadNotes(reagentKey, index);
        });
    }

    function loadNotes(reagentKey, index) {
        db.ref('community_notes/' + reagentKey).limitToLast(5).once('value', (snap) => {
            const container = document.getElementById(`notes-list-${index}`);
            const data = snap.val();
            if(!data) { container.innerHTML = "<small style='color:#999;'>No community hacks yet.</small>"; return; }
            let html = "<strong>Community Hacks:</strong>";
            for(let id in data) { html += `<div style="background:rgba(46, 204, 113, 0.1); padding:5px; border-radius:4px; margin-top:4px; font-size:0.9em;">üí° ${data[id].text}</div>`; }
            container.innerHTML = html;
        });
    }

    function toggleForm() {
        const f = document.getElementById('formOverlay');
        f.style.display = (f.style.display === 'flex') ? 'none' : 'flex';
    }

    function addReaction() {
        const reagent = document.getElementById('newReagent').value;
        if(!reagent) return alert("Reagent is required!");
        db.ref('custom_reactions').push({
            reagent,
            name: document.getElementById('newName').value,
            function: document.getElementById('newFunction').value,
            warning: document.getElementById('newWarning').value,
            diagram: document.getElementById('newDiagram').value,
            notes: document.getElementById('newNotes').value,
            category: 'General'
        }).then(() => { toggleForm(); });
    }

    function toggleTheme() {
        const h = document.documentElement;
        const t = h.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        h.setAttribute('data-theme', t);
        localStorage.setItem('theme', t);
        document.getElementById('themeBtn').innerText = t === 'light' ? 'üåô Dark Mode' : '‚òÄÔ∏è Light Mode';
    }

    function filterByCat(cat, e) {
        currentFilter = cat;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        runSearch();
    }

    document.getElementById('mainSearch').addEventListener('input', runSearch);
</script>
</body>
</html>







